// Danh sách sản phẩm mẫu
let products = [
  { id: 1, name: "Gấu Teddy Nâu", price: 250000, desc: "Gấu bông mềm mại, cao 40cm", img: "https://loremflickr.com/300/300/teddybear?random=1" },
  { id: 2, name: "Gấu Hồng Trái Tim", price: 300000, desc: "Gấu màu hồng dễ thương", img: "https://loremflickr.com/300/300/teddybear?random=2" },
  { id: 3, name: "Gấu Trắng Khổng Lồ", price: 550000, desc: "Cao 80cm, ôm cực thích", img: "https://loremflickr.com/300/300/teddybear?random=3" }
];

if (!localStorage.getItem("products")) {
  localStorage.setItem("products", JSON.stringify(products));
} else {
  products = JSON.parse(localStorage.getItem("products"));
}

function showProducts() {
  const container = document.getElementById("product-list");
  if (!container) return;
  container.innerHTML = "";
  products.forEach(p => {
    container.innerHTML += `
      <div class="product">
        <img src="${p.img}" alt="${p.name}">
        <h3>${p.name}</h3>
        <p><strong>${p.price.toLocaleString()} VND</strong></p>
        <button onclick="viewDetail(${p.id})">Xem chi tiết</button>
      </div>
    `;
  });
}

function viewDetail(id) {
  const p = products.find(x => x.id === id);
  if (p) {
    alert(`Tên: ${p.name}\nGiá: ${p.price.toLocaleString()} VND\nMô tả: ${p.desc}`);
  }
}

function register() {
  const username = document.getElementById("reg-username").value;
  const password = document.getElementById("reg-password").value;
  if (!username || !password) return alert("Vui lòng nhập đầy đủ!");

  let users = JSON.parse(localStorage.getItem("users") || "[]");
  if (users.find(u => u.username === username)) return alert("Tài khoản đã tồn tại!");

  users.push({ username, password, role: "user" });
  localStorage.setItem("users", JSON.stringify(users));
  alert("Đăng ký thành công! Hãy đăng nhập.");
}

function login() {
  const username = document.getElementById("login-username").value;
  const password = document.getElementById("login-password").value;

  let users = JSON.parse(localStorage.getItem("users") || "[]");
  const user = users.find(u => u.username === username && u.password === password);

  if (!user) return alert("Sai tài khoản hoặc mật khẩu!");

  localStorage.setItem("currentUser", JSON.stringify(user));
  alert("Đăng nhập thành công!");
  window.location.href = "index.html";
}

function checkLogin() {
  const user = localStorage.getItem("currentUser");
  if (user) {
    document.getElementById("user-info").innerText = "Xin chào: " + JSON.parse(user).username;
    document.getElementById("logout-btn").classList.remove("hidden");
  }
}

function logout() {
  localStorage.removeItem("currentUser");
  alert("Đã đăng xuất!");
  window.location.href = "index.html";
}

function forgotPassword() {
  const username = prompt("Nhập tên đăng nhập:");
  let users = JSON.parse(localStorage.getItem("users") || "[]");
  const user = users.find(u => u.username === username);
  if (user) {
    const newPass = prompt("Nhập mật khẩu mới:");
    user.password = newPass;
    localStorage.setItem("users", JSON.stringify(users));
    alert("Đặt lại mật khẩu thành công!");
  } else {
    alert("Không tìm thấy tài khoản!");
  }
}

function loadAdmin() {
  const user = localStorage.getItem("currentUser");
  if (!user || JSON.parse(user).role !== "admin") {
    alert("Bạn không có quyền truy cập trang này!");
    window.location.href = "index.html";
    return;
  }

  let users = JSON.parse(localStorage.getItem("users") || "[]");
  if (!users.find(u => u.username === "admin")) {
    users.push({ username: "admin", password: "123", role: "admin" });
    localStorage.setItem("users", JSON.stringify(users));
  }

  showAdminProducts();
}

function showAdminProducts() {
  const container = document.getElementById("admin-list");
  if (!container) return;
  container.innerHTML = "";
  products.forEach(p => {
    container.innerHTML += `
      <div class="product">
        <img src="${p.img}">
        <h3>${p.name}</h3>
        <p>${p.price.toLocaleString()} VND</p>
        <button onclick="deleteProduct(${p.id})">Xóa</button>
      </div>
    `;
  });
}

function addProduct() {
  const name = document.getElementById("p-name").value;
  const price = parseInt(document.getElementById("p-price").value);
  const desc = document.getElementById("p-desc").value;
  const img = document.getElementById("p-img").value || "https://loremflickr.com/300/300/teddybear";

  if (!name || !price) return alert("Nhập tên và giá!");

  const newProduct = { id: Date.now(), name, price, desc, img };
  products.push(newProduct);
  localStorage.setItem("products", JSON.stringify(products));
  alert("Thêm sản phẩm thành công!");
  showAdminProducts();
  showProducts();
}

function deleteProduct(id) {
  if (confirm("Xóa sản phẩm này?")) {
    products = products.filter(p => p.id !== id);
    localStorage.setItem("products", JSON.stringify(products));
    showAdminProducts();
    showProducts();
  }
}

